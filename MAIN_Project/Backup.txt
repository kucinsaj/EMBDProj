RS EQU P2.7
RW EQU P2.6
E  EQU P2.5
ORG 000H
MOV DPTR,#LUT
SETB P3.5
CLR P2.0
MOV TMOD,#00100001B
MOV TL1,#00D
ACALL DINT

ACALL TEXT1

MAIN: MOV R1,#16D
      SETB P3.5
      CLR P3.5
      ;ACALL DELAY1
      SETB P3.5
HERE:JB P3.5,HERE
HERE1:JNB P3.5,HERE1
HERE2:JB P3.5,HERE2
LOOP:JNB P3.5,LOOP
     RL A
     MOV R0,A
     SETB TR1
HERE4:JB P3.5,HERE4
      CLR TR1
      MOV A,TL1
      SUBB A,#50D
      MOV A,R0
      JB PSW.7, NEXT
      SETB ACC.0
      SJMP ESC
NEXT:CLR ACC.0
ESC: MOV TL1,#00D
     CLR PSW.7
     DJNZ R1,LOOP
     ACALL DINT
     ACALL TEXT1
     ACALL LINE2
     ACALL TEXT2
     ACALL HMDTY
     ACALL CHECK
     ACALL DELAY2
     LJMP MAIN


DELAY1: MOV TH0,#0B9H
        MOV TL0,#0B0H
        SETB TR0
HERE5: JNB TF0,HERE5
       CLR TR0
       CLR TF0
       RET 

DELAY2:MOV R1,#112D
  BACK:ACALL DELAY1
       DJNZ R1,BACK
       RET
 
 CHECK:MOV A,R0
       MOV B,#65D
       SUBB A,B
       JB PSW.7,NEXT1
       ACALL TEXT3
       SETB P2.0
       SJMP ESC1
  NEXT1:ACALL TEXT4
        CLR P2.0
  ESC1:CLR PSW.7
       RET

 CMD: MOV P0,A
    CLR RS
    CLR RW
    SETB E
    CLR E
    ;ACALL DELAY
    RET

WRITE:

MOV P0,A
    SETB RS
    CLR RW
    SETB E
    CLR E
   ; ACALL DELAY
    RET

HMDTY:MOV A,R0
      MOV B,#10D
      DIV AB
      MOV R2,B
      MOV B,#10D
      DIV AB
      ACALL ASCII
      ACALL WRITE
      MOV A,B
      ACALL ASCII
      ACALL WRITE
      MOV A,R2
      ACALL ASCII
      ACALL WRITE
      MOV A,#'%'
      ACALL WRITE
      RET


TEXT1: MOV A,#'h'
       ACALL WRITE
       MOV A,#'y'
       ACALL WRITE
       MOV A,#'g'
       ACALL WRITE
       MOV A,#'r'
       ACALL WRITE
       MOV A,#'o'
       ACALL WRITE
       MOV A,#'m'
       ACALL WRITE
       MOV A,#'e'
       ACALL WRITE
       MOV A,#'t'
       ACALL WRITE
       MOV A,#'e'
       ACALL WRITE
       MOV A,#'r'
       ACALL WRITE
       RET      
       
TEXT2: MOV A,#'R'
       ACALL WRITE
       MOV A,#'H'
       ACALL WRITE
       MOV A,#' '
       ACALL WRITE
       MOV A,#'='
       ACALL WRITE
       MOV A,#' '
       ACALL WRITE
       RET 
 TEXT3: MOV A,#' '
       ACALL WRITE
       MOV A,#' '
       ACALL WRITE
       MOV A,#'O'
       ACALL WRITE
       MOV A,#'N'
       ACALL WRITE
       RET
 
 TEXT4:MOV A,#' '
       ACALL WRITE
       MOV A,#'O'
       ACALL WRITE
       MOV A,#'F'
       ACALL WRITE
       MOV A,#'F'
       ACALL WRITE
       RET
 
 DINT:MOV A,#38H 
    ACALL CMD
    MOV A,#0FH 
    ACALL CMD
    MOV A,#1H 
    ACALL CMD
    MOV A,#6H
    ACALL CMD
    MOV A,#80H 
    ACALL CMD
    RET
    
LINE2:MOV A,#0C0H 
      ACALL CMD
      RET
          
          
DELAY: CLR E
    CLR RS
    SETB RW
    MOV P0,#0FFH
    SETB E
    MOV A,P0
    JB ACC.7,DELAY
    CLR E
    CLR RW
    RET

ASCII: MOVC A,@A+DPTR
       RET
ENDP:
SJMP ENDP
LUT: DB  48D
     DB  49D
     DB  50D
     DB  51D
     DB  52D
     DB  53D
     DB  54D
     DB  55D
     DB  56D
     DB  57D
    END











*****TEST******

;;;;;;;;;; Initialise Values ;;;;;;;;;;;;;;;;;
Timer_CTR .EQU  33H
UPPER	.EQU	40H
LOWER	.EQU	41H
ASTOR	.EQU	42H
CLR	P2.6	; Clear R/W
CLR	P2.7	; Clear RS
CLR	P2.5	; Clear Enable


INITIALIZE_LCD:
;MOV     TIMER_CTR, #3H ; Make timer loop  times (3 x 10ms = 30ms)
;LCALL	TIMERLOOP ; 30ms timer
MOV	P0, #38H
LCALL ENB
;LCALL	USTIMER
MOV	P0, #0FH
LCALL ENB
;LCALL	USTIMER	; 50us timer
MOV	P0, #1H
LCALL ENB
;LCALL	USTIMER ; 1.7ms timer
MOV	P0, #6H
LCALL ENB
;LCALL	USTIMER
MOV	P0, #80H
LCALL ENB
;LCALL TIMER

LCALL CLEAR



;LCALL	TIMER
;SETB 	P2.7
;LCALL	USTIMER
TOP:
MOV A, #00110000b
LCALL WRITE
MOV A, #00110000b
LCALL WRITE

LCALL ENDIT


SJMP	TOP

TIMERLOOP:
LCALL   TIMER                   ; 39 us delay
DJNZ    Timer_CTR, TIMERLOOP    ; loop if Greater Than 0
MOV     TIMER_CTR, #1H 		; Reset timer count to 1
RET

TIMER:                      ; 10 ms timer
MOV     TMOD,#01h               ; set timer mode
CLR     TF0                     ; Clear timer done
CLR     TR0                     ; Clear time run
MOV     TH0, #0D8H              ; High byte of 55,535
MOV     TL0, #0EFH              ; Low byte of 55,535;
;MOV 	TH0, #0FFH	;Test Num	
; 	TL0, #0FAH	;Test Num
SETB    TR0                     ; Start the timer
JNB     TF0,$                   ; Stay here until TF0 is set
RET                             ; End timer sub-routine


USTIMER:                      ; 39 us timer
MOV     TMOD,#01h               ; set timer mode
CLR     TF0                     ; Clear timer done
CLR     TR0                     ; Clear time run
MOV     TH0, #0F0H              ; High byte of 65,496
MOV     TL0, #0CDH              ; Low byte of 65,496
;MOV 	TH0, #0FFH	;Test Num	
;MOV 	TL0, #0FAH	;Test Num
SETB    TR0                     ; Start the timer
JNB     TF0,$                   ; Stay here until TF0 is set
RET                             ; End timer sub-routine

fTIMER:                      ; 39 us timer
MOV     TMOD,#01h               ; set timer mode
CLR     TF0                     ; Clear timer done
CLR     TR0                     ; Clear time run
MOV     TH0, #0F9H              ; High byte of 65,496
MOV     TL0, #05BH              ; Low byte of 65,496
;MOV 	TH0, #0FFH	;Test Num	
;MOV 	TL0, #0FAH	;Test Num
SETB    TR0                     ; Start the timer
JNB     TF0,$                   ; Stay here until TF0 is set
RET                             ; End timer sub-routine
ENB:
setb p2.5
nop
clr p2.5
RET

WRITE:
SETB    P2.7
NOP
SETB	P2.5
NOP
ClR	P2.5
NOP
CLR	P2.7
;LCALL TIMER
RET
HOME:
MOV	P0, #02H
LCALL ENB
RET
CLEAR:
MOV 	A, #0H  		; Re-Start accumulator with value 0
MOV 	ASTOR, #00H
MOV	UPPER, #00H		;0 UPPER
MOV 	LOWER, #00H		;0 LOWER
RET

ENDIT:
SJMP ENDIT

.END








